<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Atividades - Estudantes</title>
    <script src="https://cdn.tailwindcss.com/3.3.0"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .carousel-container {
            scroll-behavior: smooth;
        }
        
        .module-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .module-content.expanded {
            max-height: 1000px;
        }
        
        .login-overlay {
            backdrop-filter: blur(10px);
        }
        
        .carousel-dot {
            transition: all 0.3s ease;
        }
        
        .carousel-dot.active {
            background-color: #3b82f6;
            transform: scale(1.2);
        }
        
        .activity-item {
            transition: all 0.2s ease;
        }
        
        .activity-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .activity-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }
        
        .activity-item.drag-over {
            border: 2px dashed #3b82f6;
            background-color: #dbeafe;
        }
        
        .drag-handle {
            font-size: 12px;
            line-height: 1;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .sync-indicator.syncing {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-orange-50 to-amber-100 min-h-screen">
    <!-- Sync Indicator -->
    <div id="syncIndicator" class="sync-indicator bg-green-500 text-white px-3 py-1 rounded-full text-sm hidden">
        üîÑ Sincronizando...
    </div>

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-black bg-opacity-50 login-overlay flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-orange-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Portal de Atividades</h2>
                <p class="text-gray-600 mt-2">Selecione seu tipo de acesso</p>
            </div>
            
            <div class="space-y-4 mb-6">
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectUserType('student')" id="studentBtn" class="py-2 px-3 border-2 border-orange-500 text-orange-500 rounded-lg transition duration-200 hover:bg-orange-50 text-sm">
                        üë®‚Äçüéì Aluno
                    </button>
                    <button onclick="selectUserType('teacher')" id="teacherBtn" class="py-2 px-3 border-2 border-gray-300 text-gray-500 rounded-lg transition duration-200 hover:bg-gray-50 text-sm">
                        üë©‚Äçüè´ Professor
                    </button>
                    <button onclick="selectUserType('admin')" id="adminBtn" class="py-2 px-3 border-2 border-gray-300 text-gray-500 rounded-lg transition duration-200 hover:bg-gray-50 text-sm">
                        üëë Admin
                    </button>
                </div>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div id="subjectSelectDiv" class="hidden mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selecione a Mat√©ria</label>
                    <select id="loginSubjectSelect" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span id="passwordLabel">Senha de Acesso</span>
                    </label>
                    <input type="password" id="passwordInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent" placeholder="Digite sua senha">
                    <div class="mt-2 text-xs text-gray-500">
                        <div id="studentHint" class="block">üí° Digite o c√≥digo de acesso do m√≥dulo</div>
                        <div id="teacherHint" class="hidden">üí° Digite sua senha de professor</div>
                        <div id="adminHint" class="hidden">üí° Senha do administrador: <span class="font-mono">admin123</span></div>
                    </div>
                </div>
                <button type="submit" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200">
                    Entrar
                </button>
                <div id="errorMessage" class="text-red-500 text-sm text-center hidden">Senha incorreta. Tente novamente.</div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Portal de Atividades</h1>
                        <p class="text-gray-600 mt-1">Organize suas atividades por mat√©ria e m√≥dulo</p>
                        <div id="syncStatus" class="text-xs text-green-600 mt-1">
                            ‚úÖ Dados sincronizados automaticamente
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div id="lastSyncTime" class="text-xs text-gray-500"></div>
                        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200">
                            Sair
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Subject Carousel -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Selecione uma Mat√©ria</h2>
                
                <!-- Carousel Navigation -->
                <div class="flex justify-center mb-4">
                    <div id="carouselDots" class="flex space-x-2">
                    </div>
                </div>

                <!-- Carousel Container -->
                <div class="relative overflow-hidden">
                    <div id="carouselContainer" class="flex transition-transform duration-500 ease-in-out">
                    </div>
                </div>

                <!-- Navigation Arrows -->
                <div class="flex justify-between items-center mt-6">
                    <button onclick="previousSubject()" class="bg-orange-200 hover:bg-orange-300 text-orange-700 p-3 rounded-full transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <button onclick="nextSubject()" class="bg-orange-200 hover:bg-orange-300 text-orange-700 p-3 rounded-full transition duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Admin Panel (Only for Teachers) -->
        <div id="adminPanel" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-8 hidden">
            <!-- Admin Navigation Tabs -->
            <div class="bg-white rounded-2xl shadow-xl mb-6">
                <div class="flex border-b border-gray-200 flex-wrap" id="adminTabs">
                    <button onclick="showAdminTab('subjects')" id="subjectsTab" class="flex-1 py-4 px-4 text-center font-semibold text-orange-600 border-b-2 border-orange-600 bg-orange-50 text-sm admin-only">
                        üìö Mat√©rias
                    </button>
                    <button onclick="showAdminTab('modules')" id="modulesTab" class="flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm admin-only">
                        üìã M√≥dulos
                    </button>
                    <button onclick="showAdminTab('activities')" id="activitiesTab" class="flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm">
                        ‚úèÔ∏è Atividades
                    </button>
                    <button onclick="showAdminTab('users')" id="usersTab" class="flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm admin-only">
                        üë• Usu√°rios
                    </button>
                    <button onclick="showAdminTab('access')" id="accessTab" class="flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm admin-only">
                        üîê Acessos
                    </button>
                    <button onclick="showAdminTab('sync')" id="syncTab" class="flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm admin-only">
                        üîÑ Sincroniza√ß√£o
                    </button>
                </div>
            </div>

            <!-- Subjects Management -->
            <div id="subjectsPanel" class="bg-white rounded-2xl shadow-xl p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Mat√©rias</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adicionar Nova Mat√©ria</h4>
                        <input type="text" id="newSubjectKey" placeholder="ID da mat√©ria (ex: fisica)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="newSubjectName" placeholder="Nome da mat√©ria (ex: F√≠sica)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="newSubjectDescription" placeholder="Descri√ß√£o (ex: Mec√¢nica e Eletricidade)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="newSubjectEmoji" placeholder="Emoji (ex: ‚ö°)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="newSubjectColor" placeholder="Cor (ex: red-500)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="addSubject()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Adicionar Mat√©ria
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Mat√©rias Existentes</h4>
                        <div id="subjectsList" class="space-y-2 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Modules Management -->
            <div id="modulesPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar M√≥dulos</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adicionar Novo M√≥dulo</h4>
                        <select id="moduleSubjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <input type="text" id="newModuleName" placeholder="Nome do m√≥dulo" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="addModule()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Adicionar M√≥dulo
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">M√≥dulos por Mat√©ria</h4>
                        <select id="viewModulesSelect" onchange="loadModulesList()" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <div id="modulesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Activities Management -->
            <div id="activitiesPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Atividades</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adicionar Nova Atividade</h4>
                        <select id="activitySubjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2" onchange="updateActivityModuleSelect()">
                        </select>
                        <select id="activityModuleSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <input type="text" id="activityTitle" placeholder="T√≠tulo da atividade" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <textarea id="activityDescription" placeholder="Descri√ß√£o da atividade" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2 h-20"></textarea>
                        <input type="url" id="activityLink" placeholder="Link da atividade (opcional)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="addActivity()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Adicionar Atividade
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Atividades Existentes</h4>
                        <select id="viewActivitiesSubjectSelect" onchange="updateViewActivitiesModuleSelect()" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <select id="viewActivitiesModuleSelect" onchange="loadActivitiesList()" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <div id="activitiesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Users Management -->
            <div id="usersPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar Professores</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Adicionar Novo Professor</h4>
                        <select id="teacherSubjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <input type="text" id="teacherName" placeholder="Nome do professor" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="password" id="teacherPassword" placeholder="Senha do professor" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="addTeacher()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Adicionar Professor
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Professores por Mat√©ria</h4>
                        <select id="viewTeachersSelect" onchange="loadTeachersList()" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <div id="teachersList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Access Management -->
            <div id="accessPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gerenciar C√≥digos de Acesso</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Definir C√≥digo para M√≥dulo</h4>
                        <select id="accessSubjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2" onchange="updateAccessModuleSelect()">
                        </select>
                        <select id="accessModuleSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        </select>
                        <input type="text" id="moduleAccessCode" placeholder="C√≥digo de acesso (ex: MAT01)" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="setModuleAccess()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Definir C√≥digo
                        </button>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">C√≥digos Ativos</h4>
                        <div id="accessCodesList" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Sync Management Panel -->
            <div id="syncPanel" class="bg-white rounded-2xl shadow-xl p-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üîÑ Configura√ß√£o de Banco de Dados</h3>
                
                <!-- Sync Status -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 mb-2">üìä Status do Sistema</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-blue-600">√öltima sincroniza√ß√£o:</span>
                            <div id="lastSyncDisplay" class="font-mono text-gray-700">Nunca</div>
                        </div>
                        <div>
                            <span class="text-blue-600">Banco de dados:</span>
                            <div id="dbStatus" class="font-mono text-gray-700">N√£o configurado</div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Blob Store Configuration -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">üóÑÔ∏è Configurar Vercel Blob Store</h4>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                            <p class="text-sm text-green-800">
                                <strong>üí° Como configurar:</strong><br>
                                1. Acesse seu projeto no Vercel Dashboard<br>
                                2. V√° em Storage ‚Üí Create Database ‚Üí Blob<br>
                                3. Copie o BLOB_READ_WRITE_TOKEN<br>
                                4. Os dados ser√£o salvos automaticamente no Blob Store
                            </p>
                        </div>
                        <input type="password" id="blobToken" placeholder="BLOB_READ_WRITE_TOKEN do Vercel" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <input type="text" id="blobFilename" placeholder="Nome do arquivo (ex: portal-data.json)" value="portal-data.json" class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                        <button onclick="configureBlobStore()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200 mb-2">
                            Configurar Blob Store
                        </button>
                        <button onclick="testBlobConnection()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                            Testar Conex√£o
                        </button>
                    </div>

                    <!-- Manual Sync and Settings -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">üîÑ Controles de Sincroniza√ß√£o</h4>
                        <div class="space-y-2">
                            <button onclick="forceSyncFromDatabase()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                üì• Sincronizar do Banco
                            </button>
                            <button onclick="forceSaveToDatabase()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                üì§ Salvar no Banco
                            </button>
                            <button onclick="exportToJson()" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-lg transition duration-200">
                                üìã Exportar JSON
                            </button>
                        </div>
                        
                        <!-- Sync Settings -->
                        <div class="mt-4 p-3 bg-gray-50 rounded-lg space-y-2">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="autoSyncEnabled" onchange="toggleAutoSync()" class="rounded">
                                <span class="text-sm">Sincroniza√ß√£o autom√°tica (a cada 30s)</span>
                            </label>
                            <div id="autoSyncStatus" class="text-xs text-gray-500">Desabilitada</div>
                        </div>
                    </div>
                </div>

                <!-- Sync Log -->
                <div class="mt-6">
                    <h4 class="font-semibold text-gray-700 mb-3">üìã Log de Sincroniza√ß√£o</h4>
                    <div id="syncLog" class="bg-gray-50 rounded-lg p-3 max-h-40 overflow-y-auto text-sm font-mono">
                        Sistema iniciado - aguardando configura√ß√£o...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Persistence System with Vercel Database
        const STORAGE_KEY = 'portal_atividades_data';
        const SYNC_CONFIG_KEY = 'portal_sync_config';
        
        let syncConfig = {
            blobToken: null,
            blobFilename: 'portal-data.json',
            autoSync: false,
            lastSync: null,
            syncInterval: null,
            useLocalStorage: false // Agora usa apenas Blob Store
        };

        // Authentication System
        let systemData = {
            admin: {
                password: 'admin123'
            },
            subjects: {},
            moduleAccess: {} // c√≥digos de acesso para m√≥dulos
        };
        
        let currentUser = {
            type: null, // 'admin', 'teacher', 'student'
            subjectKey: null, // para professores e alunos
            name: null
        };
        let currentSubject = 0;

        // Sync Functions
        function loadSyncConfig() {
            try {
                const saved = localStorage.getItem(SYNC_CONFIG_KEY);
                if (saved) {
                    syncConfig = { ...syncConfig, ...JSON.parse(saved) };
                }
                updateSyncDisplay();
                if (syncConfig.autoSync && syncConfig.csvUrl) {
                    startAutoSync();
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√£o de sincroniza√ß√£o:', error);
            }
        }

        function saveSyncConfig() {
            try {
                localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(syncConfig));
            } catch (error) {
                console.error('Erro ao salvar configura√ß√£o de sincroniza√ß√£o:', error);
            }
        }

        function updateSyncDisplay() {
            const lastSyncDisplay = document.getElementById('lastSyncDisplay');
            const dbStatus = document.getElementById('dbStatus');
            const autoSyncStatus = document.getElementById('autoSyncStatus');
            const blobTokenInput = document.getElementById('blobToken');
            const blobFilenameInput = document.getElementById('blobFilename');
            const autoSyncEnabled = document.getElementById('autoSyncEnabled');
            const useLocalStorageCheckbox = document.getElementById('useLocalStorage');

            if (lastSyncDisplay) {
                lastSyncDisplay.textContent = syncConfig.lastSync ? 
                    new Date(syncConfig.lastSync).toLocaleString('pt-BR') : 'Nunca';
            }

            if (dbStatus) {
                if (syncConfig.blobToken) {
                    dbStatus.textContent = 'Blob Store configurado';
                } else {
                    dbStatus.textContent = 'N√£o configurado';
                }
            }

            if (autoSyncStatus) {
                autoSyncStatus.textContent = syncConfig.autoSync ? 
                    'Ativa (sincroniza a cada 30s)' : 'Desabilitada';
            }

            if (blobTokenInput) {
                blobTokenInput.value = syncConfig.blobToken || '';
            }

            if (blobFilenameInput) {
                blobFilenameInput.value = syncConfig.blobFilename || 'portal-data.json';
            }

            if (autoSyncEnabled) {
                autoSyncEnabled.checked = syncConfig.autoSync;
            }

            if (useLocalStorageCheckbox) {
                useLocalStorageCheckbox.checked = syncConfig.useLocalStorage;
            }

            // Update header sync status
            const syncStatus = document.getElementById('syncStatus');
            const lastSyncTime = document.getElementById('lastSyncTime');
            
            if (syncStatus) {
                if (syncConfig.blobToken) {
                    syncStatus.innerHTML = 'üóÑÔ∏è Sincroniza√ß√£o com Blob Store ativa';
                    syncStatus.className = 'text-xs text-green-600 mt-1';
                } else {
                    syncStatus.innerHTML = '‚ö†Ô∏è Blob Store n√£o configurado';
                    syncStatus.className = 'text-xs text-yellow-600 mt-1';
                }
            }

            if (lastSyncTime && syncConfig.lastSync) {
                lastSyncTime.textContent = `√öltima sync: ${new Date(syncConfig.lastSync).toLocaleTimeString('pt-BR')}`;
            }
        }

        function addToSyncLog(message) {
            const syncLog = document.getElementById('syncLog');
            if (syncLog) {
                const timestamp = new Date().toLocaleTimeString('pt-BR');
                syncLog.innerHTML += `\n[${timestamp}] ${message}`;
                syncLog.scrollTop = syncLog.scrollHeight;
            }
            console.log(`[SYNC] ${message}`);
        }

        function showSyncIndicator(message) {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                indicator.textContent = message;
                indicator.classList.remove('hidden');
                indicator.classList.add('syncing');
                
                setTimeout(() => {
                    indicator.classList.add('hidden');
                    indicator.classList.remove('syncing');
                }, 3000);
            }
        }

        // Vercel Blob Store Functions
        async function configureBlobStore() {
            const blobToken = document.getElementById('blobToken').value.trim();
            const blobFilename = document.getElementById('blobFilename').value.trim() || 'portal-data.json';
            
            if (!blobToken) {
                alert('Por favor, insira o BLOB_READ_WRITE_TOKEN do Vercel.');
                return;
            }

            try {
                addToSyncLog(`Testando conex√£o com Blob Store...`);
                
                // Test connection by trying to read (will fail if file doesn't exist, but that's ok)
                const testResponse = await fetch(`https://blob.vercel-storage.com/${blobFilename}`, {
                    method: 'HEAD',
                    headers: {
                        'Authorization': `Bearer ${blobToken}`
                    }
                });
                
                // Even if file doesn't exist (404), the token might be valid
                // Let's try to upload a test file
                const testData = { test: true, timestamp: Date.now() };
                const uploadResponse = await fetch(`https://blob.vercel-storage.com/${blobFilename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${blobToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`HTTP ${uploadResponse.status}: ${uploadResponse.statusText}`);
                }
                
                syncConfig.blobToken = blobToken;
                syncConfig.blobFilename = blobFilename;
                syncConfig.useLocalStorage = false;
                saveSyncConfig();
                updateSyncDisplay();
                addToSyncLog(`‚úÖ Blob Store configurado com sucesso`);
                
                alert('‚úÖ Blob Store configurado com sucesso!\n\nA sincroniza√ß√£o autom√°tica est√° dispon√≠vel.');
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro: ${error.message}`);
                
                let errorMsg = '‚ùå Erro ao conectar com o Blob Store:\n\n' + error.message;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMsg += '\n\nüîß POSS√çVEIS SOLU√á√ïES:\n';
                    errorMsg += '‚Ä¢ Verifique sua conex√£o com a internet\n';
                    errorMsg += '‚Ä¢ Certifique-se que o token est√° correto\n';
                    errorMsg += '‚Ä¢ Verifique se o Blob Store est√° ativo no Vercel\n';
                    errorMsg += '‚Ä¢ Confirme se o token tem permiss√µes de leitura/escrita';
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg += '\n\nüîß Erro de autentica√ß√£o. Verifique o BLOB_READ_WRITE_TOKEN.';
                }
                
                alert(errorMsg);
            }
        }

        async function saveToBlobStore(data) {
            if (!syncConfig.blobToken || !syncConfig.blobFilename) {
                return false;
            }

            try {
                const response = await fetch(`https://blob.vercel-storage.com/${syncConfig.blobFilename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${syncConfig.blobToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                return true;
            } catch (error) {
                console.error('Erro ao salvar no Blob Store:', error);
                addToSyncLog(`Erro ao salvar no Blob Store: ${error.message}`);
                return false;
            }
        }

        async function loadFromBlobStore() {
            if (!syncConfig.blobToken || !syncConfig.blobFilename) {
                return null;
            }

            try {
                const response = await fetch(`https://blob.vercel-storage.com/${syncConfig.blobFilename}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${syncConfig.blobToken}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        // File doesn't exist yet, that's ok
                        return null;
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Erro ao carregar do Blob Store:', error);
                addToSyncLog(`Erro ao carregar do Blob Store: ${error.message}`);
                return null;
            }
        }

        async function testCsvConnection() {
            if (!syncConfig.csvUrl) {
                alert('Configure primeiro a URL do arquivo CSV.');
                return;
            }

            try {
                addToSyncLog('üîç Testando conex√£o com CSV...');
                showSyncIndicator('üîç Testando conex√£o...');
                
                const response = await fetch(syncConfig.csvUrl, { 
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const csvContent = await response.text();
                
                // Validate content
                if (csvContent.trim().toLowerCase().startsWith('<!doctype html') || 
                    csvContent.trim().toLowerCase().startsWith('<html')) {
                    throw new Error('URL retorna HTML em vez de CSV');
                }
                
                const lines = csvContent.split('\n').filter(line => line.trim());
                const headers = lines.length > 0 ? parseCSVLine(lines[0]) : [];
                
                addToSyncLog(`‚úÖ Conex√£o OK - ${lines.length} linhas, ${headers.length} colunas`);
                showSyncIndicator('‚úÖ Conex√£o OK!');
                
                let message = `‚úÖ Conex√£o bem-sucedida!\n\n`;
                message += `üìä Arquivo CSV acess√≠vel:\n`;
                message += `‚Ä¢ ${lines.length} linhas total\n`;
                message += `‚Ä¢ ${headers.length} colunas\n`;
                message += `‚Ä¢ Tamanho: ${(csvContent.length / 1024).toFixed(1)} KB\n\n`;
                
                if (headers.length > 0) {
                    message += `üìã Colunas encontradas:\n${headers.slice(0, 5).join(', ')}${headers.length > 5 ? '...' : ''}`;
                }
                
                alert(message);
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro na conex√£o: ${error.message}`);
                showSyncIndicator('‚ùå Erro na conex√£o');
                
                let errorMsg = `‚ùå Erro ao conectar com o CSV:\n\n${error.message}`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMsg += '\n\nüîß POSS√çVEIS SOLU√á√ïES:\n';
                    errorMsg += '‚Ä¢ Verifique sua conex√£o com a internet\n';
                    errorMsg += '‚Ä¢ Certifique-se que o arquivo √© p√∫blico\n';
                    errorMsg += '‚Ä¢ Tente usar uma URL diferente (Google Sheets, Dropbox, etc.)\n';
                    errorMsg += '‚Ä¢ Verifique se n√£o h√° bloqueio de CORS';
                } else if (error.message.includes('HTML')) {
                    errorMsg += '\n\nüîß A URL est√° retornando uma p√°gina web.\n';
                    errorMsg += 'Use o link direto para download do arquivo CSV.';
                }
                
                alert(errorMsg);
            }
        }

        async function forceSyncFromCsv() {
            if (!syncConfig.csvUrl) {
                alert('Configure primeiro a URL do arquivo CSV.');
                return;
            }

            try {
                showSyncIndicator('üîÑ Sincronizando dados...');
                addToSyncLog('üîÑ Iniciando sincroniza√ß√£o manual...');
                
                const response = await fetch(syncConfig.csvUrl, { 
                    mode: 'cors',
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const csvContent = await response.text();
                addToSyncLog(`Conte√∫do recebido: ${csvContent.length} caracteres`);
                
                // Validate content before processing
                if (csvContent.trim().toLowerCase().startsWith('<!doctype html') || 
                    csvContent.trim().toLowerCase().startsWith('<html')) {
                    throw new Error('URL retorna HTML em vez de CSV. Verifique a configura√ß√£o da URL.');
                }
                
                const success = await importFromCSV(csvContent, false);
                
                if (success) {
                    syncConfig.lastSync = Date.now();
                    saveSyncConfig();
                    updateSyncDisplay();
                    
                    addToSyncLog('‚úÖ Sincroniza√ß√£o manual conclu√≠da');
                    showSyncIndicator('‚úÖ Dados sincronizados!');
                    
                    // Force reload of all UI components
                    loadSubjects();
                    if (currentAdminTab === 'subjects') loadSubjectsList();
                    if (currentAdminTab === 'modules') loadModulesList();
                    if (currentAdminTab === 'activities') loadActivitiesList();
                    if (currentAdminTab === 'users') loadTeachersList();
                    if (currentAdminTab === 'access') loadAccessCodesList();
                    updateAllSelects();
                    
                } else {
                    throw new Error('Falha ao processar dados do CSV');
                }
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro na sincroniza√ß√£o: ${error.message}`);
                showSyncIndicator('‚ùå Erro na sincroniza√ß√£o');
                
                let errorMsg = `‚ùå Erro ao sincronizar:\n\n${error.message}`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMsg += '\n\nüîß POSS√çVEIS SOLU√á√ïES:\n';
                    errorMsg += '‚Ä¢ Verifique sua conex√£o com a internet\n';
                    errorMsg += '‚Ä¢ Certifique-se que o arquivo CSV √© p√∫blico\n';
                    errorMsg += '‚Ä¢ Tente reconfigurar a URL do CSV';
                } else if (error.message.includes('HTML')) {
                    errorMsg += '\n\nüîß A URL est√° retornando uma p√°gina web.\n';
                    errorMsg += 'Reconfigure a URL usando o formato correto.';
                }
                
                alert(errorMsg);
            }
        }

        function toggleAutoSync() {
            const enabled = document.getElementById('autoSyncEnabled').checked;
            
            if (enabled && !syncConfig.blobToken) {
                document.getElementById('autoSyncEnabled').checked = false;
                alert('Configure primeiro o Blob Store.');
                return;
            }

            syncConfig.autoSync = enabled;
            saveSyncConfig();
            updateSyncDisplay();

            if (enabled) {
                startAutoSync();
                addToSyncLog('Sincroniza√ß√£o autom√°tica ativada');
            } else {
                stopAutoSync();
                addToSyncLog('Sincroniza√ß√£o autom√°tica desativada');
            }
        }

        // Blob Store control functions
        async function testBlobConnection() {
            if (!syncConfig.blobToken) {
                alert('Configure primeiro o BLOB_READ_WRITE_TOKEN.');
                return;
            }

            try {
                addToSyncLog('üîç Testando conex√£o com Blob Store...');
                showSyncIndicator('üîç Testando conex√£o...');
                
                // Try to read existing file or create a test file
                const testFilename = 'test-connection.json';
                const testData = { test: true, timestamp: Date.now() };
                
                const response = await fetch(`https://blob.vercel-storage.com/${testFilename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${syncConfig.blobToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                addToSyncLog(`‚úÖ Conex√£o OK - Blob Store acess√≠vel`);
                showSyncIndicator('‚úÖ Conex√£o OK!');
                
                let message = `‚úÖ Conex√£o bem-sucedida!\n\n`;
                message += `üóÑÔ∏è Vercel Blob Store acess√≠vel\n`;
                message += `üìä Status: Online\n`;
                message += `üîë Autentica√ß√£o: V√°lida\n`;
                message += `üìÅ Arquivo: ${syncConfig.blobFilename}`;
                
                alert(message);
                
                // Clean up test file
                try {
                    await fetch(`https://blob.vercel-storage.com/${testFilename}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${syncConfig.blobToken}`
                        }
                    });
                } catch (e) {
                    // Ignore cleanup errors
                }
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro na conex√£o: ${error.message}`);
                showSyncIndicator('‚ùå Erro na conex√£o');
                
                let errorMsg = `‚ùå Erro ao conectar com o Blob Store:\n\n${error.message}`;
                
                if (error.message.includes('Failed to fetch') || error.message.includes('Network Error')) {
                    errorMsg += '\n\nüîß POSS√çVEIS SOLU√á√ïES:\n';
                    errorMsg += '‚Ä¢ Verifique sua conex√£o com a internet\n';
                    errorMsg += '‚Ä¢ Certifique-se que o token est√° correto\n';
                    errorMsg += '‚Ä¢ Verifique se o Blob Store est√° ativo no Vercel\n';
                    errorMsg += '‚Ä¢ Confirme se o token tem permiss√µes de leitura/escrita';
                } else if (error.message.includes('401') || error.message.includes('403')) {
                    errorMsg += '\n\nüîß Erro de autentica√ß√£o. Verifique o BLOB_READ_WRITE_TOKEN.';
                }
                
                alert(errorMsg);
            }
        }

        async function forceSyncFromDatabase() {
            if (!syncConfig.blobToken) {
                alert('Configure primeiro a conex√£o com o Blob Store.');
                return;
            }

            try {
                showSyncIndicator('üîÑ Sincronizando do Blob Store...');
                addToSyncLog('üîÑ Iniciando sincroniza√ß√£o do Blob Store...');
                
                const blobData = await loadFromBlobStore();
                
                if (blobData) {
                    systemData = {
                        admin: blobData.admin || { password: 'admin123' },
                        subjects: blobData.subjects || {},
                        moduleAccess: blobData.moduleAccess || {}
                    };
                    
                    syncConfig.lastSync = Date.now();
                    saveSyncConfig();
                    updateSyncDisplay();
                    
                    addToSyncLog('‚úÖ Sincroniza√ß√£o do Blob Store conclu√≠da');
                    showSyncIndicator('‚úÖ Dados sincronizados!');
                    
                    // Force reload of all UI components
                    loadSubjects();
                    if (currentAdminTab === 'subjects') loadSubjectsList();
                    if (currentAdminTab === 'modules') loadModulesList();
                    if (currentAdminTab === 'activities') loadActivitiesList();
                    if (currentAdminTab === 'users') loadTeachersList();
                    if (currentAdminTab === 'access') loadAccessCodesList();
                    updateAllSelects();
                    
                    alert('‚úÖ Dados sincronizados do Blob Store com sucesso!');
                } else {
                    alert('‚ÑπÔ∏è Nenhum arquivo encontrado no Blob Store. Isso √© normal na primeira vez.');
                    addToSyncLog('‚ÑπÔ∏è Nenhum arquivo encontrado no Blob Store');
                }
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro na sincroniza√ß√£o: ${error.message}`);
                showSyncIndicator('‚ùå Erro na sincroniza√ß√£o');
                alert(`‚ùå Erro ao sincronizar do Blob Store:\n\n${error.message}`);
            }
        }

        async function forceSaveToDatabase() {
            if (!syncConfig.blobToken) {
                alert('Configure primeiro a conex√£o com o Blob Store.');
                return;
            }

            try {
                showSyncIndicator('üì§ Salvando no Blob Store...');
                addToSyncLog('üì§ Salvando dados no Blob Store...');
                
                const success = await saveToBlobStore(systemData);
                
                if (success) {
                    syncConfig.lastSync = Date.now();
                    saveSyncConfig();
                    updateSyncDisplay();
                    
                    addToSyncLog('‚úÖ Dados salvos no Blob Store com sucesso');
                    showSyncIndicator('‚úÖ Dados salvos!');
                    alert('‚úÖ Dados salvos no Blob Store com sucesso!');
                } else {
                    throw new Error('Falha ao salvar no Blob Store');
                }
                
            } catch (error) {
                addToSyncLog(`‚ùå Erro ao salvar: ${error.message}`);
                showSyncIndicator('‚ùå Erro ao salvar');
                alert(`‚ùå Erro ao salvar no Blob Store:\n\n${error.message}`);
            }
        }

        function exportToJson() {
            const jsonContent = JSON.stringify(systemData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `portal_atividades_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            addToSyncLog('Dados exportados para JSON');
            alert('üìä Dados exportados para JSON! Use este arquivo como backup.');
        }



        function startAutoSync() {
            if (syncConfig.syncInterval) {
                clearInterval(syncConfig.syncInterval);
            }

            syncConfig.syncInterval = setInterval(async () => {
                if (syncConfig.autoSync && syncConfig.blobToken) {
                    try {
                        const blobData = await loadFromBlobStore();
                        
                        if (blobData) {
                            // Check if data has changed
                            const currentDataString = JSON.stringify(systemData);
                            const newDataString = JSON.stringify(blobData);
                            
                            if (currentDataString !== newDataString) {
                                systemData = {
                                    admin: blobData.admin || { password: 'admin123' },
                                    subjects: blobData.subjects || {},
                                    moduleAccess: blobData.moduleAccess || {}
                                };
                                
                                syncConfig.lastSync = Date.now();
                                saveSyncConfig();
                                updateSyncDisplay();
                                
                                // Reload UI if data changed
                                loadSubjects();
                                
                                // Show subtle indicator for successful auto-sync
                                const indicator = document.getElementById('syncIndicator');
                                if (indicator) {
                                    indicator.textContent = '‚úÖ Sincronizado';
                                    indicator.classList.remove('hidden');
                                    indicator.classList.add('bg-green-500');
                                    indicator.classList.remove('syncing');
                                    
                                    setTimeout(() => {
                                        indicator.classList.add('hidden');
                                    }, 2000);
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Auto-sync error:', error);
                        addToSyncLog(`Auto-sync falhou: ${error.message}`);
                        
                        // Update sync status to show error
                        const syncStatus = document.getElementById('syncStatus');
                        if (syncStatus) {
                            syncStatus.innerHTML = '‚ö†Ô∏è Erro na sincroniza√ß√£o autom√°tica';
                            syncStatus.className = 'text-xs text-red-600 mt-1';
                        }
                    }
                }
            }, 30000); // 30 seconds
        }

        function stopAutoSync() {
            if (syncConfig.syncInterval) {
                clearInterval(syncConfig.syncInterval);
                syncConfig.syncInterval = null;
            }
        }

        function generateSampleCsv() {
            let csvContent = "Tipo,ID_Materia,Nome_Materia,Descricao_Materia,Emoji_Materia,Cor_Materia,Nome_Modulo,ID_Professor,Nome_Professor,Senha_Professor,Titulo_Atividade,Descricao_Atividade,Link_Atividade,Codigo_Acesso,Senha_Admin\n";
            
            // Add admin password
            csvContent += `Admin,,,,,,,,,,,,,"admin123"\n`;
            
            // Add sample data structure (empty but showing format)
            csvContent += `Materia,"matematica","Matem√°tica","√Ålgebra e Geometria","üìä","blue-500",,,,,,,,\n`;
            csvContent += `Modulo,"matematica","Matem√°tica","√Ålgebra e Geometria","üìä","blue-500","M√≥dulo 1: √Ålgebra",,,,,,,"MAT01",\n`;
            csvContent += `Atividade,"matematica","Matem√°tica","√Ålgebra e Geometria","üìä","blue-500","M√≥dulo 1: √Ålgebra",,,"Exerc√≠cios de Equa√ß√µes","Resolva as equa√ß√µes propostas","https://exemplo.com/exercicios","MAT01",\n`;
            csvContent += `Professor,"matematica","Matem√°tica","√Ålgebra e Geometria","üìä","blue-500",,"prof1","Prof. Jo√£o Silva","mat123",,,,\n`;
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'portal_atividades_modelo.csv';
            link.click();
            
            addToSyncLog('CSV modelo gerado');
            alert('üìã Arquivo CSV modelo gerado!\n\nEste arquivo cont√©m exemplos de como estruturar seus dados.\nEdite o arquivo com suas pr√≥prias mat√©rias e fa√ßa upload para uma pasta compartilhada.');
        }

        // Data Persistence Functions
        async function saveData() {
            try {
                // If Blob Store is configured, save there
                if (syncConfig.blobToken) {
                    const success = await saveToBlobStore(systemData);
                    if (success) {
                        syncConfig.lastSync = Date.now();
                        saveSyncConfig();
                        addToSyncLog('Dados salvos no Blob Store com sucesso');
                    } else {
                        addToSyncLog('Falha ao salvar no Blob Store');
                    }
                }
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                addToSyncLog(`Erro ao salvar: ${error.message}`);
            }
        }

        async function loadData() {
            try {
                let loadedFromBlobStore = false;
                
                // Try to load from Blob Store if configured
                if (syncConfig.blobToken) {
                    const blobData = await loadFromBlobStore();
                    if (blobData) {
                        systemData = {
                            admin: blobData.admin || { password: 'admin123' },
                            subjects: blobData.subjects || {},
                            moduleAccess: blobData.moduleAccess || {}
                        };
                        syncConfig.lastSync = Date.now();
                        saveSyncConfig();
                        addToSyncLog('Dados carregados do Blob Store com sucesso');
                        loadedFromBlobStore = true;
                    } else {
                        addToSyncLog('Nenhum arquivo encontrado no Blob Store');
                    }
                }
                
                return loadedFromBlobStore;
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                addToSyncLog(`Erro ao carregar: ${error.message}`);
                alert('Erro ao carregar dados salvos. Usando dados padr√£o.');
                return false;
            }
        }

        function exportToCsvFile() {
            let csvContent = "Tipo,ID_Materia,Nome_Materia,Descricao_Materia,Emoji_Materia,Cor_Materia,Nome_Modulo,ID_Professor,Nome_Professor,Senha_Professor,Titulo_Atividade,Descricao_Atividade,Link_Atividade,Codigo_Acesso,Senha_Admin\n";
            
            // Export admin password first
            csvContent += `Admin,,,,,,,,,,,,,"${systemData.admin.password}"\n`;
            
            // Export subjects and all related data
            Object.keys(systemData.subjects).forEach(subjectKey => {
                const subject = systemData.subjects[subjectKey];
                
                // Export each module with its data
                subject.modules.forEach((module, moduleIndex) => {
                    const moduleKey = `${subjectKey}-${moduleIndex}`;
                    const accessCode = systemData.moduleAccess[moduleKey] || '';
                    
                    if (module.activities.length === 0) {
                        // Module without activities
                        csvContent += `Modulo,"${subjectKey}","${subject.name}","${subject.description}","${subject.emoji}","${subject.color}","${module.name}",,,,,,,"${accessCode}",\n`;
                    } else {
                        // Module with activities
                        module.activities.forEach(activity => {
                            csvContent += `Atividade,"${subjectKey}","${subject.name}","${subject.description}","${subject.emoji}","${subject.color}","${module.name}",,,"${activity.title}","${activity.description}","${activity.link || ''}","${accessCode}",\n`;
                        });
                    }
                });
                
                // Export teachers for this subject
                subject.teachers.forEach(teacher => {
                    csvContent += `Professor,"${subjectKey}","${subject.name}","${subject.description}","${subject.emoji}","${subject.color}",,"${teacher.id}","${teacher.name}","${teacher.password}",,,,\n`;
                });
                
                // If subject has no modules, export just the subject
                if (subject.modules.length === 0) {
                    csvContent += `Materia,"${subjectKey}","${subject.name}","${subject.description}","${subject.emoji}","${subject.color}",,,,,,,,\n`;
                }
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `portal_atividades_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            addToSyncLog('Dados exportados para CSV');
            alert('üìä Dados exportados para CSV! Fa√ßa upload deste arquivo para sua pasta compartilhada.');
        }

        async function importFromCSV(csvContent, silent = false) {
            try {
                if (!silent) {
                    addToSyncLog('Iniciando importa√ß√£o do CSV...');
                }
                
                // Backup current data
                const backup = JSON.parse(JSON.stringify(systemData));
                
                // Start with current data structure to preserve existing data
                const newData = {
                    admin: { password: systemData.admin.password },
                    subjects: JSON.parse(JSON.stringify(systemData.subjects)), // Preserve existing subjects
                    moduleAccess: { ...systemData.moduleAccess } // Preserve existing access codes
                };

                const lines = csvContent.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    throw new Error('Arquivo CSV vazio');
                }
                
                const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim());
                addToSyncLog(`Headers encontrados: ${headers.join(', ')}`);
                
                let processedRows = 0;
                let skippedRows = 0;
                let updatedSubjects = new Set();
                
                // Process each line
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    if (values.length === 0) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = (values[index] || '').replace(/"/g, '').trim();
                    });
                    
                    const result = processCSVRow(row, newData);
                    if (result) {
                        processedRows++;
                        
                        // Track which subjects were updated
                        const subjectKey = getSubjectKeyFromRow(row);
                        if (subjectKey) {
                            updatedSubjects.add(subjectKey);
                        }
                    } else {
                        skippedRows++;
                    }
                }
                
                // Apply changes if any data was processed
                if (processedRows > 0) {
                    // Remove duplicates and validate data integrity
                    cleanupDuplicateData(newData);
                    
                    systemData = newData;
                    saveData();
                    addToSyncLog(`${processedRows} linhas processadas, ${updatedSubjects.size} mat√©rias atualizadas`);
                    
                    // Force complete UI reload
                    setTimeout(() => {
                        loadSubjects();
                        if (document.getElementById('subjectsList')) {
                            loadSubjectsList();
                        }
                        if (document.getElementById('teachersList')) {
                            loadTeachersList();
                        }
                        if (document.getElementById('accessCodesList')) {
                            loadAccessCodesList();
                        }
                        if (document.getElementById('modulesList')) {
                            loadModulesList();
                        }
                        if (document.getElementById('activitiesList')) {
                            loadActivitiesList();
                        }
                        updateAllSelects();
                    }, 100);
                    
                    if (!silent) {
                        alert(`‚úÖ Dados CSV importados com sucesso!\n\nüìä Resultado:\n‚Ä¢ ${processedRows} registros processados\n‚Ä¢ ${updatedSubjects.size} mat√©rias atualizadas\n‚Ä¢ ${skippedRows} linhas ignoradas`);
                    }
                } else {
                    throw new Error('Nenhum dado v√°lido encontrado no CSV');
                }
                
                return true;
                
            } catch (error) {
                addToSyncLog(`Erro na importa√ß√£o: ${error.message}`);
                console.error('CSV Import error:', error);
                if (!silent) {
                    alert(`‚ùå Erro ao processar arquivo CSV:\n${error.message}\n\nVerifique o formato do arquivo.`);
                }
                return false;
            }
        }

        // Clean up duplicate data and ensure integrity
        function cleanupDuplicateData(data) {
            Object.keys(data.subjects).forEach(subjectKey => {
                const subject = data.subjects[subjectKey];
                
                // Remove duplicate teachers
                const uniqueTeachers = [];
                const seenTeacherPasswords = new Set();
                const seenTeacherNames = new Set();
                
                subject.teachers.forEach(teacher => {
                    const key = `${teacher.name}-${teacher.password}`;
                    if (!seenTeacherPasswords.has(teacher.password) && !seenTeacherNames.has(teacher.name)) {
                        uniqueTeachers.push(teacher);
                        seenTeacherPasswords.add(teacher.password);
                        seenTeacherNames.add(teacher.name);
                    }
                });
                subject.teachers = uniqueTeachers;
                
                // Remove duplicate modules
                const uniqueModules = [];
                const seenModuleNames = new Set();
                
                subject.modules.forEach(module => {
                    if (!seenModuleNames.has(module.name)) {
                        // Remove duplicate activities within module
                        const uniqueActivities = [];
                        const seenActivityTitles = new Set();
                        
                        module.activities.forEach(activity => {
                            if (!seenActivityTitles.has(activity.title)) {
                                uniqueActivities.push(activity);
                                seenActivityTitles.add(activity.title);
                            }
                        });
                        
                        module.activities = uniqueActivities;
                        uniqueModules.push(module);
                        seenModuleNames.add(module.name);
                    }
                });
                subject.modules = uniqueModules;
            });
        }

        // Helper function to find value in row using multiple possible column names
        function findValueInRow(row, possibleKeys) {
            for (const key of possibleKeys) {
                if (row[key] && row[key].toString().trim()) {
                    return row[key].toString().trim();
                }
                
                // Also try case-insensitive matching
                const foundKey = Object.keys(row).find(rowKey => 
                    rowKey.toLowerCase().trim() === key.toLowerCase().trim()
                );
                if (foundKey && row[foundKey] && row[foundKey].toString().trim()) {
                    return row[foundKey].toString().trim();
                }
            }
            return '';
        }

        function getSubjectKeyFromRow(row) {
            // Try to extract subject key from row
            const subjectKeys = Object.keys(row).filter(key => 
                key.toLowerCase().includes('materia') || 
                key.toLowerCase().includes('subject') ||
                key.toLowerCase().includes('id_materia') ||
                key.toLowerCase().includes('subjectid')
            );
            
            if (subjectKeys.length > 0) {
                return (row[subjectKeys[0]] || '').toString().trim();
            }
            return null;
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                        // Handle escaped quotes
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            values.push(current.trim());
            return values.map(v => v.replace(/^"|"$/g, '')); // Remove surrounding quotes
        }

        function processCSVRow(row, targetData) {
            // Check if row has any meaningful data first
            const hasAnyData = Object.values(row).some(value => value && value.toString().trim() !== '');
            
            if (!hasAnyData) {
                return false;
            }
            
            // Try multiple strategies to find tipo
            let tipo = '';
            
            // Strategy 1: Look for explicit tipo columns
            const tipoKeys = Object.keys(row).filter(key => {
                const lowerKey = key.toLowerCase().trim();
                return lowerKey === 'tipo' || lowerKey === 'type' || 
                       lowerKey.includes('tipo') || lowerKey.includes('type');
            });
            
            if (tipoKeys.length > 0) {
                tipo = (row[tipoKeys[0]] || '').toString().trim();
            }
            
            // Strategy 2: Try first column if no tipo column found
            if (!tipo) {
                const firstKey = Object.keys(row)[0];
                const firstValue = (row[firstKey] || '').toString().trim();
                
                // Check if first value looks like a tipo
                const validTipos = [
                    'Admin', 'admin', 'ADMIN',
                    'Materia', 'materia', 'MATERIA', 'Subject', 'subject', 'SUBJECT',
                    'Modulo', 'modulo', 'MODULO', 'Module', 'module', 'MODULE',
                    'Atividade', 'atividade', 'ATIVIDADE', 'Activity', 'activity', 'ACTIVITY',
                    'Professor', 'professor', 'PROFESSOR', 'Teacher', 'teacher', 'TEACHER'
                ];
                
                if (validTipos.includes(firstValue)) {
                    tipo = firstValue;
                }
            }
            
            // Strategy 3: Try to infer tipo from available data
            if (!tipo) {
                const adminPassword = findValueInRow(row, ['Senha_Admin', 'senha_admin', 'AdminPassword', 'admin_password']);
                const teacherName = findValueInRow(row, ['Nome_Professor', 'nome_professor', 'TeacherName', 'teacher_name']);
                const moduleName = findValueInRow(row, ['Nome_Modulo', 'nome_modulo', 'ModuleName', 'module_name']);
                const activityTitle = findValueInRow(row, ['Titulo_Atividade', 'titulo_atividade', 'ActivityTitle', 'activity_title']);
                const subjectName = findValueInRow(row, ['Nome_Materia', 'nome_materia', 'SubjectName', 'subject_name']);
                
                if (adminPassword) {
                    tipo = 'Admin';
                } else if (teacherName) {
                    tipo = 'Professor';
                } else if (activityTitle) {
                    tipo = 'Atividade';
                } else if (moduleName) {
                    tipo = 'Modulo';
                } else if (subjectName) {
                    tipo = 'Materia';
                }
            }
            
            // Try to find subject key with more flexible matching
            let subjectKey = findValueInRow(row, [
                'ID_Materia', 'id_materia', 'SubjectID', 'subject_id', 'subjectid',
                'Materia', 'materia', 'Subject', 'subject'
            ]);
            
            // Process admin password
            const adminPassword = findValueInRow(row, ['Senha_Admin', 'senha_admin', 'AdminPassword', 'admin_password']);
            if ((tipo.toLowerCase().includes('admin') || !tipo) && adminPassword) {
                targetData.admin.password = adminPassword;
                return true;
            }
            
            // Skip if no tipo found
            if (!tipo) {
                return false;
            }
            
            // For non-admin rows, we need subject key
            if (!subjectKey && !tipo.toLowerCase().includes('admin')) {
                return false;
            }
            
            // Ensure subject exists
            if (subjectKey && !targetData.subjects[subjectKey]) {
                const subjectName = findValueInRow(row, ['Nome_Materia', 'nome_materia', 'SubjectName', 'subject_name']) || subjectKey;
                const subjectDesc = findValueInRow(row, ['Descricao_Materia', 'descricao_materia', 'SubjectDescription', 'subject_description']) || '';
                const subjectEmoji = findValueInRow(row, ['Emoji_Materia', 'emoji_materia', 'SubjectEmoji', 'subject_emoji']) || 'üìö';
                const subjectColor = findValueInRow(row, ['Cor_Materia', 'cor_materia', 'SubjectColor', 'subject_color']) || 'blue-500';
                
                targetData.subjects[subjectKey] = {
                    name: subjectName,
                    description: subjectDesc,
                    emoji: subjectEmoji,
                    color: subjectColor,
                    teachers: [],
                    modules: []
                };
            }
            
            const subject = targetData.subjects[subjectKey];
            if (!subject && !tipo.toLowerCase().includes('admin')) {
                return false;
            }
            
            // Get data using flexible column matching
            const teacherName = findValueInRow(row, ['Nome_Professor', 'nome_professor', 'TeacherName', 'teacher_name']);
            const moduleName = findValueInRow(row, ['Nome_Modulo', 'nome_modulo', 'ModuleName', 'module_name']);
            const activityTitle = findValueInRow(row, ['Titulo_Atividade', 'titulo_atividade', 'ActivityTitle', 'activity_title']);
            const accessCode = findValueInRow(row, ['Codigo_Acesso', 'codigo_acesso', 'AccessCode', 'access_code']);
            
            // Process based on tipo
            const tipoLower = tipo.toLowerCase();
            
            if (tipoLower.includes('professor') || tipoLower.includes('teacher')) {
                if (teacherName) {
                    const existingTeacher = subject.teachers.find(t => t.name === teacherName);
                    if (!existingTeacher) {
                        const teacherPassword = findValueInRow(row, ['Senha_Professor', 'senha_professor', 'TeacherPassword', 'teacher_password']) || 'temp123';
                        const teacherId = findValueInRow(row, ['ID_Professor', 'id_professor', 'TeacherID', 'teacher_id']) || Date.now().toString();
                        
                        subject.teachers.push({
                            id: teacherId,
                            name: teacherName,
                            password: teacherPassword
                        });
                    }
                    return true;
                }
            } else if ((tipoLower.includes('modulo') || tipoLower.includes('module') || 
                       tipoLower.includes('atividade') || tipoLower.includes('activity')) && moduleName) {
                
                // Find or create module
                let module = subject.modules.find(m => m.name === moduleName);
                if (!module) {
                    module = {
                        name: moduleName,
                        activities: []
                    };
                    subject.modules.push(module);
                    
                    // Set access code if provided
                    if (accessCode) {
                        const moduleIndex = subject.modules.length - 1;
                        const moduleKey = `${subjectKey}-${moduleIndex}`;
                        targetData.moduleAccess[moduleKey] = accessCode;
                    }
                }
                
                // Add activity if it's an activity row
                if ((tipoLower.includes('atividade') || tipoLower.includes('activity')) && activityTitle) {
                    const existingActivity = module.activities.find(a => a.title === activityTitle);
                    if (!existingActivity) {
                        const activityDesc = findValueInRow(row, ['Descricao_Atividade', 'descricao_atividade', 'ActivityDescription', 'activity_description']) || '';
                        const activityLink = findValueInRow(row, ['Link_Atividade', 'link_atividade', 'ActivityLink', 'activity_link']);
                        
                        module.activities.push({
                            title: activityTitle,
                            description: activityDesc,
                            link: activityLink || null
                        });
                    }
                }
                return true;
            } else if (tipoLower.includes('materia') || tipoLower.includes('subject')) {
                // Subject already created above
                return true;
            }
            
            return false;
        }

        // Default empty data structure
        const DEFAULT_SAMPLE_DATA = {
            subjects: {},
            moduleAccess: {}
        };

        let currentAdminTab = 'subjects';

        // User type selection
        function selectUserType(type) {
            currentUser.type = type;
            
            // Reset all buttons to default state
            const buttons = ['studentBtn', 'teacherBtn', 'adminBtn'];
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.className = 'py-2 px-3 border-2 border-gray-300 text-gray-500 rounded-lg transition duration-200 hover:bg-gray-50 text-sm';
                }
            });
            
            // Reset all hints to hidden
            const hints = ['studentHint', 'teacherHint', 'adminHint'];
            hints.forEach(hintId => {
                const hint = document.getElementById(hintId);
                if (hint) {
                    hint.classList.add('hidden');
                }
            });
            
            // Get common elements
            const subjectSelectDiv = document.getElementById('subjectSelectDiv');
            const passwordLabel = document.getElementById('passwordLabel');
            
            // Configure based on selected type
            if (type === 'student') {
                const studentBtn = document.getElementById('studentBtn');
                const studentHint = document.getElementById('studentHint');
                
                if (studentBtn) {
                    studentBtn.className = 'py-2 px-3 border-2 border-orange-500 bg-orange-500 text-white rounded-lg transition duration-200 text-sm';
                }
                if (studentHint) {
                    studentHint.classList.remove('hidden');
                }
                if (subjectSelectDiv) {
                    subjectSelectDiv.classList.remove('hidden');
                }
                if (passwordLabel) {
                    passwordLabel.textContent = 'C√≥digo de Acesso do M√≥dulo';
                }
                updateLoginSubjectSelect();
                
            } else if (type === 'teacher') {
                const teacherBtn = document.getElementById('teacherBtn');
                const teacherHint = document.getElementById('teacherHint');
                
                if (teacherBtn) {
                    teacherBtn.className = 'py-2 px-3 border-2 border-amber-500 bg-amber-500 text-white rounded-lg transition duration-200 text-sm';
                }
                if (teacherHint) {
                    teacherHint.classList.remove('hidden');
                }
                if (subjectSelectDiv) {
                    subjectSelectDiv.classList.add('hidden');
                }
                if (passwordLabel) {
                    passwordLabel.textContent = 'Senha do Professor';
                }
                
            } else if (type === 'admin') {
                const adminBtn = document.getElementById('adminBtn');
                const adminHint = document.getElementById('adminHint');
                
                if (adminBtn) {
                    adminBtn.className = 'py-2 px-3 border-2 border-red-500 bg-red-500 text-white rounded-lg transition duration-200 text-sm';
                }
                if (adminHint) {
                    adminHint.classList.remove('hidden');
                }
                if (subjectSelectDiv) {
                    subjectSelectDiv.classList.add('hidden');
                }
                if (passwordLabel) {
                    passwordLabel.textContent = 'Senha do Administrador';
                }
            }
            
            // Clear any previous error messages
            const errorMessage = document.getElementById('errorMessage');
            if (errorMessage) {
                errorMessage.classList.add('hidden');
            }
            
            // Clear password field
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.value = '';
            }
        }

        function updateLoginSubjectSelect() {
            const select = document.getElementById('loginSubjectSelect');
            select.innerHTML = '';
            
            Object.keys(systemData.subjects).forEach(key => {
                const subject = systemData.subjects[key];
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${subject.emoji} ${subject.name}`;
                select.appendChild(option);
            });
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const password = document.getElementById('passwordInput').value;
            let loginSuccess = false;
            
            if (currentUser.type === 'admin') {
                // Admin login
                if (password === systemData.admin.password) {
                    currentUser.name = 'Administrador';
                    loginSuccess = true;
                }
            } else if (currentUser.type === 'teacher') {
                // Teacher login - check all subjects for matching teacher password
                Object.keys(systemData.subjects).forEach(subjectKey => {
                    const subject = systemData.subjects[subjectKey];
                    subject.teachers.forEach(teacher => {
                        if (teacher.password === password) {
                            currentUser.name = teacher.name;
                            currentUser.subjectKey = subjectKey; // Store which subject this teacher belongs to
                            loginSuccess = true;
                        }
                    });
                });
            } else if (currentUser.type === 'student') {
                // Student login - check module access codes
                const selectedSubject = document.getElementById('loginSubjectSelect').value;
                Object.keys(systemData.moduleAccess).forEach(key => {
                    if (systemData.moduleAccess[key] === password && key.startsWith(selectedSubject + '-')) {
                        currentUser.name = 'Aluno';
                        currentUser.subjectKey = selectedSubject;
                        currentUser.moduleIndex = parseInt(key.split('-')[1]); // Store allowed module index
                        loginSuccess = true;
                    }
                });
            }
            
            if (loginSuccess) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                
                // Show admin panel for admin and teachers
                if (currentUser.type === 'admin') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    showAdminTab('subjects');
                } else if (currentUser.type === 'teacher') {
                    document.getElementById('adminPanel').classList.remove('hidden');
                    showAdminTab('activities'); // Teachers start on activities tab
                } else {
                    document.getElementById('adminPanel').classList.add('hidden');
                }
                
                // Sync data first if Blob Store is configured
                if (syncConfig.blobToken) {
                    forceSyncFromDatabase().then(() => {
                        loadSubjects();
                    }).catch(() => {
                        loadSubjects(); // Load anyway if sync fails
                    });
                    
                    // Start auto-sync
                    if (syncConfig.autoSync) {
                        startAutoSync();
                    }
                } else {
                    loadSubjects();
                }
            } else {
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        });

        function logout() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('passwordInput').value = '';
            document.getElementById('errorMessage').classList.add('hidden');
            
            // Stop auto-sync
            stopAutoSync();
            
            // Reset current user
            currentUser = {
                type: null,
                subjectKey: null,
                name: null,
                moduleIndex: null
            };
            
            // Reset to student selection
            setTimeout(() => {
                selectUserType('student');
            }, 100);
        }

        // Admin Tab Management
        function showAdminTab(tabName) {
            // Check if teacher is trying to access admin-only tabs
            if (currentUser.type === 'teacher' && ['subjects', 'modules', 'users', 'access', 'sync'].includes(tabName)) {
                alert('Voc√™ n√£o tem permiss√£o para acessar esta se√ß√£o.');
                return;
            }
            
            currentAdminTab = tabName;
            
            // Hide all panels
            const panels = ['subjectsPanel', 'modulesPanel', 'activitiesPanel', 'usersPanel', 'accessPanel', 'syncPanel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (panel) panel.classList.add('hidden');
            });
            
            // Reset all tab styles
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.className = 'flex-1 py-4 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 text-sm';
            });
            
            // Show selected panel and update tab style
            const selectedPanel = document.getElementById(tabName + 'Panel');
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedPanel) selectedPanel.classList.remove('hidden');
            if (selectedTab) selectedTab.className = 'flex-1 py-4 px-4 text-center font-semibold text-orange-600 border-b-2 border-orange-600 bg-orange-50 text-sm';
            
            // Hide admin-only tabs for teachers
            if (currentUser.type === 'teacher') {
                document.querySelectorAll('.admin-only').forEach(tab => {
                    tab.style.display = 'none';
                });
                // Make activities tab full width for teachers
                const activitiesTab = document.getElementById('activitiesTab');
                if (activitiesTab) activitiesTab.className = 'w-full py-4 px-4 text-center font-semibold text-orange-600 border-b-2 border-orange-600 bg-orange-50 text-sm';
            } else {
                document.querySelectorAll('.admin-only').forEach(tab => {
                    tab.style.display = 'block';
                });
            }
            
            // Load data for the selected tab
            if (tabName === 'subjects') {
                loadSubjectsList();
            } else if (tabName === 'modules') {
                updateModuleSelects();
            } else if (tabName === 'activities') {
                updateActivitySelects();
            } else if (tabName === 'users') {
                updateTeacherSelects();
                loadTeachersList();
            } else if (tabName === 'access') {
                updateAccessSelects();
                loadAccessCodesList();
            } else if (tabName === 'sync') {
                updateSyncDisplay();
            }
        }

        // Carousel functionality
        function buildCarousel() {
            const container = document.getElementById('carouselContainer');
            const dotsContainer = document.getElementById('carouselDots');
            
            // Filter subjects based on user type
            let availableSubjects = systemData.subjects;
            
            // For teachers, only show their assigned subject
            if (currentUser.type === 'teacher' && currentUser.subjectKey) {
                availableSubjects = {};
                availableSubjects[currentUser.subjectKey] = systemData.subjects[currentUser.subjectKey];
            }
            
            const subjectKeys = Object.keys(availableSubjects);
            container.innerHTML = '';
            dotsContainer.innerHTML = '';
            
            // Show empty state if no subjects
            if (subjectKeys.length === 0) {
                showEmptyState();
                return;
            }
            
            subjectKeys.forEach((key, index) => {
                const subject = availableSubjects[key];
                
                // Create carousel slide
                const slide = document.createElement('div');
                slide.className = 'w-full flex-shrink-0';
                slide.innerHTML = `
                    <div class="bg-white rounded-2xl shadow-xl p-6 mx-2">
                        <div class="text-center mb-6">
                            <div class="w-20 h-20 bg-${subject.color} rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-3xl">${subject.emoji}</span>
                            </div>
                            <h3 class="text-2xl font-bold text-gray-800">${subject.name}</h3>
                            <p class="text-gray-600">${subject.description}</p>
                        </div>
                        <div id="${key}-modules" class="space-y-4"></div>
                    </div>
                `;
                container.appendChild(slide);
                
                // Create dot
                const dot = document.createElement('button');
                dot.className = `carousel-dot w-3 h-3 rounded-full bg-gray-300 ${index === 0 ? 'active' : ''}`;
                dot.onclick = () => showSubject(index);
                dotsContainer.appendChild(dot);
            });
        }

        function showSubject(index) {
            // Filter subjects based on user type
            let availableSubjects = systemData.subjects;
            
            // For teachers, only show their assigned subject
            if (currentUser.type === 'teacher' && currentUser.subjectKey) {
                availableSubjects = {};
                availableSubjects[currentUser.subjectKey] = systemData.subjects[currentUser.subjectKey];
            }
            
            const subjectKeys = Object.keys(availableSubjects);
            if (index >= subjectKeys.length) index = 0;
            if (index < 0) index = subjectKeys.length - 1;
            
            currentSubject = index;
            
            // Update carousel position
            const container = document.getElementById('carouselContainer');
            container.style.transform = `translateX(-${index * 100}%)`;
            
            // Update dots
            document.querySelectorAll('.carousel-dot').forEach((dot, i) => {
                if (i === index) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
            
            // Load modules for current subject
            const subjectKey = subjectKeys[index];
            loadModulesForSubject(subjectKey);
        }

        function nextSubject() {
            showSubject(currentSubject + 1);
        }

        function previousSubject() {
            showSubject(currentSubject - 1);
        }

        function loadModulesForSubject(subjectKey) {
            const subject = systemData.subjects[subjectKey];
            if (!subject) return;
            
            const modulesContainer = document.getElementById(`${subjectKey}-modules`);
            if (!modulesContainer) return;
            
            modulesContainer.innerHTML = '';
            
            subject.modules.forEach((module, moduleIndex) => {
                const moduleKey = `${subjectKey}-${moduleIndex}`;
                const hasAccess = currentUser.type === 'admin' || 
                                 currentUser.type === 'teacher' || 
                                 (currentUser.type === 'student' && currentUser.moduleIndex === moduleIndex);
                
                const moduleDiv = document.createElement('div');
                moduleDiv.className = `border border-gray-200 rounded-lg ${hasAccess ? 'bg-white' : 'bg-gray-100'}`;
                
                const accessCode = systemData.moduleAccess[moduleKey];
                const lockIcon = hasAccess ? '' : 'üîí';
                const accessInfo = (currentUser.type === 'admin' || currentUser.type === 'teacher') && accessCode ? 
                    `<span class="text-xs text-gray-500 ml-2">(C√≥digo: ${accessCode})</span>` : '';
                
                moduleDiv.innerHTML = `
                    <div class="p-4">
                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleModule('${moduleKey}')">
                            <h4 class="font-semibold text-gray-800">${lockIcon} ${module.name} ${accessInfo}</h4>
                            <svg id="${moduleKey}-arrow" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                        <div id="${moduleKey}-content" class="module-content mt-4">
                            <div class="space-y-3">
                                ${module.activities.map(activity => `
                                    <div class="activity-item bg-gray-50 p-3 rounded-lg ${hasAccess ? 'hover:bg-gray-100' : 'opacity-50'}">
                                        <h5 class="font-medium text-gray-800">${activity.title}</h5>
                                        <p class="text-sm text-gray-600 mt-1">${activity.description}</p>
                                        ${activity.link && hasAccess ? 
                                            `<a href="${activity.link}" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 text-blue-600 hover:text-blue-800 text-sm">
                                                üîó Acessar atividade
                                            </a>` : 
                                            (activity.link && !hasAccess ? '<p class="text-sm text-gray-400 mt-2">üîí Link dispon√≠vel ap√≥s acesso</p>' : '')
                                        }
                                    </div>
                                `).join('')}
                                ${module.activities.length === 0 ? '<p class="text-gray-500 text-sm">Nenhuma atividade cadastrada ainda.</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                modulesContainer.appendChild(moduleDiv);
            });
            
            if (subject.modules.length === 0) {
                modulesContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhum m√≥dulo cadastrado ainda.</p>';
            }
        }

        function showEmptyState() {
            const container = document.getElementById('carouselContainer');
            const dotsContainer = document.getElementById('carouselDots');
            
            container.innerHTML = `
                <div class="w-full flex-shrink-0">
                    <div class="bg-white rounded-2xl shadow-xl p-8 mx-2 text-center">
                        <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-3xl">üìö</span>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Sistema Vazio</h3>
                        <p class="text-gray-600 mb-6">Nenhuma mat√©ria foi cadastrada ainda.</p>
                        <div class="space-y-3 text-sm text-gray-500">
                            <p>üí° <strong>Para come√ßar:</strong></p>
                            <p>1. Configure o banco de dados na aba Sincroniza√ß√£o</p>
                            <p>2. Ou cadastre mat√©rias manualmente no painel administrativo</p>
                        </div>
                    </div>
                </div>
            `;
            dotsContainer.innerHTML = '';
        }

        function toggleModule(moduleKey) {
            const content = document.getElementById(`${moduleKey}-content`);
            const arrow = document.getElementById(`${moduleKey}-arrow`);
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                arrow.style.transform = 'rotate(0deg)';
            } else {
                content.classList.add('expanded');
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        function loadSubjects() {
            buildCarousel();
            showSubject(0);
        }

        // Admin Functions
        function addSubject() {
            const key = document.getElementById('newSubjectKey').value.trim();
            const name = document.getElementById('newSubjectName').value.trim();
            const description = document.getElementById('newSubjectDescription').value.trim();
            const emoji = document.getElementById('newSubjectEmoji').value.trim();
            const color = document.getElementById('newSubjectColor').value.trim();
            
            if (!key || !name || !description || !emoji || !color) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            if (systemData.subjects[key]) {
                alert('J√° existe uma mat√©ria com este ID.');
                return;
            }
            
            systemData.subjects[key] = {
                name,
                description,
                emoji,
                color,
                teachers: [],
                modules: []
            };
            
            saveData();
            loadSubjectsList();
            updateAllSelects();
            loadSubjects();
            
            // Clear form
            document.getElementById('newSubjectKey').value = '';
            document.getElementById('newSubjectName').value = '';
            document.getElementById('newSubjectDescription').value = '';
            document.getElementById('newSubjectEmoji').value = '';
            document.getElementById('newSubjectColor').value = '';
            
            alert('Mat√©ria adicionada com sucesso!');
        }

        function loadSubjectsList() {
            const container = document.getElementById('subjectsList');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(systemData.subjects).forEach(key => {
                const subject = systemData.subjects[key];
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="text-lg">${subject.emoji}</span>
                        <span class="font-medium ml-2">${subject.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${key})</span>
                    </div>
                    <button onclick="deleteSubject('${key}')" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Excluir
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function deleteSubject(key) {
            if (confirm(`Tem certeza que deseja excluir a mat√©ria "${systemData.subjects[key].name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                delete systemData.subjects[key];
                
                // Remove related access codes
                Object.keys(systemData.moduleAccess).forEach(moduleKey => {
                    if (moduleKey.startsWith(key + '-')) {
                        delete systemData.moduleAccess[moduleKey];
                    }
                });
                
                saveData();
                loadSubjectsList();
                updateAllSelects();
                loadSubjects();
                alert('Mat√©ria exclu√≠da com sucesso!');
            }
        }

        function addModule() {
            const subjectKey = document.getElementById('moduleSubjectSelect').value;
            const moduleName = document.getElementById('newModuleName').value.trim();
            
            if (!subjectKey || !moduleName) {
                alert('Por favor, selecione uma mat√©ria e digite o nome do m√≥dulo.');
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject) {
                alert('Mat√©ria n√£o encontrada.');
                return;
            }
            
            // Check if module already exists
            if (subject.modules.find(m => m.name === moduleName)) {
                alert('J√° existe um m√≥dulo com este nome nesta mat√©ria.');
                return;
            }
            
            subject.modules.push({
                name: moduleName,
                activities: []
            });
            
            saveData();
            loadModulesList();
            updateAllSelects();
            loadSubjects();
            
            document.getElementById('newModuleName').value = '';
            alert('M√≥dulo adicionado com sucesso!');
        }

        function updateModuleSelects() {
            const selects = ['moduleSubjectSelect', 'viewModulesSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione uma mat√©ria</option>';
                    Object.keys(systemData.subjects).forEach(key => {
                        const subject = systemData.subjects[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${subject.emoji} ${subject.name}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function loadModulesList() {
            const subjectKey = document.getElementById('viewModulesSelect').value;
            const container = document.getElementById('modulesList');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!subjectKey) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Selecione uma mat√©ria para ver os m√≥dulos.</p>';
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject || subject.modules.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum m√≥dulo encontrado.</p>';
                return;
            }
            
            subject.modules.forEach((module, index) => {
                const moduleKey = `${subjectKey}-${index}`;
                const accessCode = systemData.moduleAccess[moduleKey] || 'Sem c√≥digo';
                
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${module.name}</span>
                        <span class="text-sm text-gray-500 ml-2">(${module.activities.length} atividades)</span>
                        <span class="text-xs text-blue-600 ml-2">C√≥digo: ${accessCode}</span>
                    </div>
                    <button onclick="deleteModule('${subjectKey}', ${index})" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Excluir
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function deleteModule(subjectKey, moduleIndex) {
            const subject = systemData.subjects[subjectKey];
            const module = subject.modules[moduleIndex];
            
            if (confirm(`Tem certeza que deseja excluir o m√≥dulo "${module.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                subject.modules.splice(moduleIndex, 1);
                
                // Remove access code
                const moduleKey = `${subjectKey}-${moduleIndex}`;
                delete systemData.moduleAccess[moduleKey];
                
                // Update access codes for remaining modules
                const newModuleAccess = {};
                Object.keys(systemData.moduleAccess).forEach(key => {
                    if (key.startsWith(subjectKey + '-')) {
                        const oldIndex = parseInt(key.split('-')[1]);
                        if (oldIndex > moduleIndex) {
                            const newKey = `${subjectKey}-${oldIndex - 1}`;
                            newModuleAccess[newKey] = systemData.moduleAccess[key];
                        } else if (oldIndex < moduleIndex) {
                            newModuleAccess[key] = systemData.moduleAccess[key];
                        }
                    } else {
                        newModuleAccess[key] = systemData.moduleAccess[key];
                    }
                });
                systemData.moduleAccess = newModuleAccess;
                
                saveData();
                loadModulesList();
                updateAllSelects();
                loadSubjects();
                alert('M√≥dulo exclu√≠do com sucesso!');
            }
        }

        function addActivity() {
            const subjectKey = document.getElementById('activitySubjectSelect').value;
            const moduleIndex = parseInt(document.getElementById('activityModuleSelect').value);
            const title = document.getElementById('activityTitle').value.trim();
            const description = document.getElementById('activityDescription').value.trim();
            const link = document.getElementById('activityLink').value.trim();
            
            if (!subjectKey || isNaN(moduleIndex) || !title || !description) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject || !subject.modules[moduleIndex]) {
                alert('Mat√©ria ou m√≥dulo n√£o encontrado.');
                return;
            }
            
            // Check if activity already exists
            if (subject.modules[moduleIndex].activities.find(a => a.title === title)) {
                alert('J√° existe uma atividade com este t√≠tulo neste m√≥dulo.');
                return;
            }
            
            subject.modules[moduleIndex].activities.push({
                title,
                description,
                link: link || null
            });
            
            saveData();
            loadActivitiesList();
            loadSubjects();
            
            // Clear form
            document.getElementById('activityTitle').value = '';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityLink').value = '';
            
            alert('Atividade adicionada com sucesso!');
        }

        function updateActivitySelects() {
            const selects = ['activitySubjectSelect', 'viewActivitiesSubjectSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione uma mat√©ria</option>';
                    
                    // For teachers, only show their assigned subject
                    let availableSubjects = systemData.subjects;
                    if (currentUser.type === 'teacher' && currentUser.subjectKey) {
                        availableSubjects = {};
                        availableSubjects[currentUser.subjectKey] = systemData.subjects[currentUser.subjectKey];
                    }
                    
                    Object.keys(availableSubjects).forEach(key => {
                        const subject = availableSubjects[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${subject.emoji} ${subject.name}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function updateActivityModuleSelect() {
            const subjectKey = document.getElementById('activitySubjectSelect').value;
            const select = document.getElementById('activityModuleSelect');
            
            select.innerHTML = '<option value="">Selecione um m√≥dulo</option>';
            
            if (!subjectKey) return;
            
            const subject = systemData.subjects[subjectKey];
            if (!subject) return;
            
            subject.modules.forEach((module, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = module.name;
                select.appendChild(option);
            });
        }

        function updateViewActivitiesModuleSelect() {
            const subjectKey = document.getElementById('viewActivitiesSubjectSelect').value;
            const select = document.getElementById('viewActivitiesModuleSelect');
            
            select.innerHTML = '<option value="">Selecione um m√≥dulo</option>';
            
            if (!subjectKey) return;
            
            const subject = systemData.subjects[subjectKey];
            if (!subject) return;
            
            subject.modules.forEach((module, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = module.name;
                select.appendChild(option);
            });
        }

        function loadActivitiesList() {
            const subjectKey = document.getElementById('viewActivitiesSubjectSelect').value;
            const moduleIndex = parseInt(document.getElementById('viewActivitiesModuleSelect').value);
            const container = document.getElementById('activitiesList');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!subjectKey || isNaN(moduleIndex)) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Selecione uma mat√©ria e m√≥dulo para ver as atividades.</p>';
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject || !subject.modules[moduleIndex]) {
                container.innerHTML = '<p class="text-gray-500 text-sm">M√≥dulo n√£o encontrado.</p>';
                return;
            }
            
            const activities = subject.modules[moduleIndex].activities;
            if (activities.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma atividade encontrada.</p>';
                return;
            }
            
            activities.forEach((activity, activityIndex) => {
                const div = document.createElement('div');
                div.className = 'p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-medium">${activity.title}</h5>
                            <p class="text-sm text-gray-600 mt-1">${activity.description}</p>
                            ${activity.link ? `<a href="${activity.link}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 text-sm">üîó ${activity.link}</a>` : ''}
                        </div>
                        <button onclick="deleteActivity('${subjectKey}', ${moduleIndex}, ${activityIndex})" class="text-red-500 hover:text-red-700 text-sm ml-2">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function deleteActivity(subjectKey, moduleIndex, activityIndex) {
            const subject = systemData.subjects[subjectKey];
            const activity = subject.modules[moduleIndex].activities[activityIndex];
            
            if (confirm(`Tem certeza que deseja excluir a atividade "${activity.title}"?`)) {
                subject.modules[moduleIndex].activities.splice(activityIndex, 1);
                saveData();
                loadActivitiesList();
                loadSubjects();
                alert('Atividade exclu√≠da com sucesso!');
            }
        }

        function addTeacher() {
            const subjectKey = document.getElementById('teacherSubjectSelect').value;
            const name = document.getElementById('teacherName').value.trim();
            const password = document.getElementById('teacherPassword').value.trim();
            
            if (!subjectKey || !name || !password) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject) {
                alert('Mat√©ria n√£o encontrada.');
                return;
            }
            
            // Check if teacher already exists
            if (subject.teachers.find(t => t.name === name || t.password === password)) {
                alert('J√° existe um professor com este nome ou senha nesta mat√©ria.');
                return;
            }
            
            subject.teachers.push({
                id: Date.now().toString(),
                name,
                password
            });
            
            saveData();
            loadTeachersList();
            
            // Clear form
            document.getElementById('teacherName').value = '';
            document.getElementById('teacherPassword').value = '';
            
            alert('Professor adicionado com sucesso!');
        }

        function updateTeacherSelects() {
            const selects = ['teacherSubjectSelect', 'viewTeachersSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione uma mat√©ria</option>';
                    Object.keys(systemData.subjects).forEach(key => {
                        const subject = systemData.subjects[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${subject.emoji} ${subject.name}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function loadTeachersList() {
            const subjectKey = document.getElementById('viewTeachersSelect').value;
            const container = document.getElementById('teachersList');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!subjectKey) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Selecione uma mat√©ria para ver os professores.</p>';
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject || subject.teachers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum professor encontrado.</p>';
                return;
            }
            
            subject.teachers.forEach((teacher, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div>
                        <span class="font-medium">${teacher.name}</span>
                        <span class="text-sm text-gray-500 ml-2">Senha: ${teacher.password}</span>
                    </div>
                    <button onclick="deleteTeacher('${subjectKey}', ${index})" class="text-red-500 hover:text-red-700 text-sm">
                        üóëÔ∏è Excluir
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function deleteTeacher(subjectKey, teacherIndex) {
            const subject = systemData.subjects[subjectKey];
            const teacher = subject.teachers[teacherIndex];
            
            if (confirm(`Tem certeza que deseja excluir o professor "${teacher.name}"?`)) {
                subject.teachers.splice(teacherIndex, 1);
                saveData();
                loadTeachersList();
                alert('Professor exclu√≠do com sucesso!');
            }
        }

        function setModuleAccess() {
            const subjectKey = document.getElementById('accessSubjectSelect').value;
            const moduleIndex = parseInt(document.getElementById('accessModuleSelect').value);
            const accessCode = document.getElementById('moduleAccessCode').value.trim();
            
            if (!subjectKey || isNaN(moduleIndex) || !accessCode) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            const subject = systemData.subjects[subjectKey];
            if (!subject || !subject.modules[moduleIndex]) {
                alert('Mat√©ria ou m√≥dulo n√£o encontrado.');
                return;
            }
            
            // Check if access code already exists
            const existingKey = Object.keys(systemData.moduleAccess).find(key => 
                systemData.moduleAccess[key] === accessCode
            );
            
            if (existingKey) {
                alert('Este c√≥digo de acesso j√° est√° sendo usado por outro m√≥dulo.');
                return;
            }
            
            const moduleKey = `${subjectKey}-${moduleIndex}`;
            systemData.moduleAccess[moduleKey] = accessCode;
            
            saveData();
            loadAccessCodesList();
            loadSubjects();
            
            document.getElementById('moduleAccessCode').value = '';
            alert('C√≥digo de acesso definido com sucesso!');
        }

        function updateAccessSelects() {
            const selects = ['accessSubjectSelect'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Selecione uma mat√©ria</option>';
                    Object.keys(systemData.subjects).forEach(key => {
                        const subject = systemData.subjects[key];
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = `${subject.emoji} ${subject.name}`;
                        select.appendChild(option);
                    });
                }
            });
        }

        function updateAccessModuleSelect() {
            const subjectKey = document.getElementById('accessSubjectSelect').value;
            const select = document.getElementById('accessModuleSelect');
            
            select.innerHTML = '<option value="">Selecione um m√≥dulo</option>';
            
            if (!subjectKey) return;
            
            const subject = systemData.subjects[subjectKey];
            if (!subject) return;
            
            subject.modules.forEach((module, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = module.name;
                select.appendChild(option);
            });
        }

        function loadAccessCodesList() {
            const container = document.getElementById('accessCodesList');
            if (!container) return;
            
            container.innerHTML = '';
            
            const accessCodes = Object.keys(systemData.moduleAccess);
            if (accessCodes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum c√≥digo de acesso definido.</p>';
                return;
            }
            
            accessCodes.forEach(moduleKey => {
                const [subjectKey, moduleIndex] = moduleKey.split('-');
                const subject = systemData.subjects[subjectKey];
                const module = subject?.modules[parseInt(moduleIndex)];
                const accessCode = systemData.moduleAccess[moduleKey];
                
                if (subject && module) {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg';
                    div.innerHTML = `
                        <div>
                            <span class="font-medium">${subject.emoji} ${subject.name}</span>
                            <span class="text-sm text-gray-600 ml-2">‚Üí ${module.name}</span>
                            <span class="text-sm font-mono bg-blue-100 text-blue-800 px-2 py-1 rounded ml-2">${accessCode}</span>
                        </div>
                        <button onclick="deleteAccessCode('${moduleKey}')" class="text-red-500 hover:text-red-700 text-sm">
                            üóëÔ∏è Remover
                        </button>
                    `;
                    container.appendChild(div);
                }
            });
        }

        function deleteAccessCode(moduleKey) {
            if (confirm('Tem certeza que deseja remover este c√≥digo de acesso?')) {
                delete systemData.moduleAccess[moduleKey];
                saveData();
                loadAccessCodesList();
                loadSubjects();
                alert('C√≥digo de acesso removido com sucesso!');
            }
        }

        function updateAllSelects() {
            updateModuleSelects();
            updateActivitySelects();
            updateTeacherSelects();
            updateAccessSelects();
            updateLoginSubjectSelect();
        }

        // Initialize the application
        async function init() {
            // Load sync configuration first
            loadSyncConfig();
            
            // Try to load saved data (now async)
            const hasData = await loadData();
            
            // If no saved data, use default sample data
            if (!hasData) {
                systemData.subjects = DEFAULT_SAMPLE_DATA.subjects;
                systemData.moduleAccess = DEFAULT_SAMPLE_DATA.moduleAccess;
                await saveData();
            }
            
            // Set default user type
            selectUserType('student');
            
            // Update all selects
            updateAllSelects();
            
            // Start auto-sync if configured
            if (syncConfig.autoSync && syncConfig.blobToken) {
                startAutoSync();
            }
        }

        // Start the application
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98c14acae42ce2a0',t:'MTc2MDA0ODcwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
